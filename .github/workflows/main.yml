name: Auto Merge Main to Test

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  merge-main-to-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure Git
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"

      - name: Fetch all branches
        run: git fetch --all

      - name: Merge Main into Test
        run: |
          set -e
          git checkout test
          git fetch origin main
          echo "Attempting to merge 'main' into 'test'..."
          git merge origin/main --no-commit --allow-unrelated-histories --no-ff || true

          if git ls-files -u | grep -q ""; then
            echo "Conflicts detected!"
            CONFLICT_FILES=$(git diff --name-only --diff-filter=U)
            echo "conflict_files=$CONFLICT_FILES" >> $GITHUB_ENV
          else
            echo "conflict_files=" >> $GITHUB_ENV
          fi
          if [ -n "$CONFLICT_FILES" ]; then
            echo "Conflicted files: $CONFLICT_FILES"
            for file in $(echo $CONFLICT_FILES); do
              git checkout --ours -- "$file"
              git add "$file"
            done
          fi
          git commit -m "Merge main into test (excluding conflicted files)" || true
          git push origin test || true

      - name: Save Conflict Files
        run: echo "$CONFLICT_FILES" > conflicts.txt
        env:
          CONFLICT_FILES: ${{ env.conflict_files }}

  notify-discord:
    runs-on: ubuntu-latest
    needs: merge-main-to-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Read Conflict Files
        run: |
          if [ -f conflicts.txt ]; then
            CONFLICT_FILES=$(cat conflicts.txt)
          else
            CONFLICT_FILES=""
          fi
          echo "CONFLICT_FILES=$CONFLICT_FILES" >> $GITHUB_ENV

      - name: Notify Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          CONFLICT_FILES: ${{ env.conflict_files }}
          JOB_STATUS: ${{ needs.merge-main-to-test.result }}
        run: |
          MESSAGE=""
          if [ "$JOB_STATUS" == "failure" ]; then
            MESSAGE="üö® **Job Failed:** \`merge-main-to-test\`\n- **Status:** \`Failure\`\n- **Time:** \`$(date -u +'%Y-%m-%d %H:%M:%S UTC')\`\n\nPlease review the logs for details."
          elif [ "$JOB_STATUS" == "success" ]; then
            MESSAGE="‚úÖ **Workflow completed successfully!**\n- **Job:** \`merge-main-to-test\`\n- **Branch:** \`main\` ‚Üí \`test\`\n- **Time:** \`$(date -u +'%Y-%m-%d %H:%M:%S UTC')\`."
          else
            MESSAGE="‚ö†Ô∏è **Workflow completed with warnings.**\n- **Job:** \`merge-main-to-test\`\n- **Status:** \`$JOB_STATUS\`\n- **Branch:** \`main\` ‚Üí \`test\`\n- **Time:** \`$(date -u +'%Y-%m-%d %H:%M:%S UTC')\`\n\nPlease check the logs for details."
          fi

          if [ -n "$CONFLICT_FILES" ]; then
            CONFLICT_LIST=$(echo "$CONFLICT_FILES")
            MESSAGE="$MESSAGE\n\nüõë **Conflicted Files:**\n\`\`\`\n$CONFLICT_LIST\n\`\`\`"
          else
            MESSAGE="$MESSAGE\n\n‚úÖ **No conflicts detected!**"
          fi

          curl -X POST -H "Content-Type: application/json" \
          -d "{
            \"content\": \"$MESSAGE\"
          }" \
          $DISCORD_WEBHOOK_URL
